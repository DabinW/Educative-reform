function resizeIframe(a){a.style.height=a.contentWindow.document.body.scrollHeight+"px"}function getObjects(a,b,c){var d=[];for(var e in a)a.hasOwnProperty(e)&&("object"==typeof a[e]?d=d.concat(getObjects(a[e],b,c)):e==b&&a[b]==c&&d.push(a));return d}function QueryString(){for(var a={},b=window.location.search.substring(1),c=b.split("&"),d=0;d<c.length;d++){var e=c[d].split("=");if(void 0===a[e[0]])a[e[0]]=e[1];else if("string"==typeof a[e[0]]){var f=[a[e[0]],e[1]];a[e[0]]=f}else a[e[0]].push(e[1])}return a}function setObjectPropsToValue(a,b,c,d){for(var e in a)if("object"!=typeof a[e]){var f=b.indexOf(e);f>=0?a[e]=c:"boolean"==typeof c&&d&&(a[e]=!c)}else a[e]=setObjectPropsToValue(a[e],b,c);return a}function setObjectFieldToValue(a,b,c,d,e){if(b in a&&(a[b]==c||a[b][0]==c)){for(var f in a)f==d&&(a[f]=e);return a}if("object"==typeof a||"array"==typeof a)for(var f in a)if("object"==typeof a[f]){var g=setObjectFieldToValue(a[f],b,c,d,e);if(null!=g)return a[f]=g,a}return null}function setArrayToChartArray(a,b,c){for(var d=[],e=0;e<a.length;e++){var f={x:a[e][b],y:a[e][c]};d.push(f)}return d}function getTabId(a,b,c){var d=[];for(var e in a)if(a.hasOwnProperty(e)&&"object"==typeof a[e]&&(d=d.concat(getObjects(a[e],b,c)),d.length>0))return e;return-1}function clone(a){if(null==a||"object"!=typeof a)return a;if(a instanceof Date){var b=new Date;return b.setTime(a.getTime()),b}if(a instanceof Array){for(var b=[],c=a.length,d=0;d<c;++d)b[d]=clone(a[d]);return b}if(a instanceof Object){var b={};for(var e in a)a.hasOwnProperty(e)&&(b[e]=clone(a[e]));return b}throw new Error("Unable to copy obj! Its type isn't supported.")}Date.prototype.Format=function(a){var b={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};/(y+)/.test(a)&&(a=a.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var c in b)new RegExp("("+c+")").test(a)&&(a=a.replace(RegExp.$1,1==RegExp.$1.length?b[c]:("00"+b[c]).substr((""+b[c]).length)));return a},app.service("tableService",["$http","$rootScope","DTColumnDefBuilder","DTOptionsBuilder","DTInstances","DTColumnBuilder","localStorageService",function(b,c,d,e,f,g,h){function m(){return i}function n(a,b){if(null!=b){return e.newOptions().withOption("ajax",{url:b,type:"get"}).withBootstrap().withPaginationType("full_numbers").withDisplayLength(10).withDOM(a).withLanguage({sUrl:rootpath+"/JsonData/InputJSON/DTLanguage.json"})}return e.newOptions().withBootstrap().withPaginationType("full_numbers").withDisplayLength(10).withDOM(a).withLanguage({sUrl:l})}function o(a,c){var e=[];return b.post("\\DataImport\\ActionRoute",{action:"GetDataTableColumnSets",baseinfo:k,AskString:a,remark:systemname}).then(function(a){return i=a.data,void 0!=i&&null!=i&&i.length>0&&(c&&e.push(d.newColumnDef(0)),angular.forEach(i,function(a,b,c){e.push(d.newColumnDef(b+c))})),e})}function p(a,b,d,g,h){return e.newOptions().withOption("ajax",{url:a,data:b,type:"POST"}).withBootstrap().withOption("fnInitComplete",function(){f.getList().then(function(a){c[g]=a[d]})}).withOption("preDrawCallback",function(a){void 0!=a.json&&null!=a.json&&(c[h]=a.json)}).withPaginationType("full_numbers").withDisplayLength(10).withLanguage({sUrl:l})}function q(a,b,d,g,h){return e.newOptions().withOption("ajax",{url:a,data:b,type:"POST"}).withDataProp("data").withOption("processing",!0).withOption("serverSide",!0).withBootstrap().withOption("fnInitComplete",function(){f.getList().then(function(a){c[g]=a[d]})}).withOption("preDrawCallback",function(a){void 0!=a.json&&null!=a.json&&(c[h]=a.json.data)}).withPaginationType("full_numbers").withDisplayLength(10).withLanguage({sUrl:l})}function r(a,c){var d=[];return b.post("\\DataImport\\GetDataTableColumnSets",{baseinfo:k,AskString:a,remark:systemname}).then(function(a){return i=a.data,void 0!=i&&null!=i&&i.length>0&&(c&&d.push(g.newColumn(null).withTitle("")),angular.forEach(i,function(a,b,c){d.push(g.newColumn(a.ColDBName).withTitle(a.ColCHName).withOption("defaultContent"," "))})),d})}var i=[],j=h.get(systemname+"LoginInfo"),k="",l="/BigDataMgt/JsonData/InputJSON/DTLanguage.json";return null!=j&&(k=j._id),{initSimpleTablesOption:n,initSimpleDTColumnDefs:o,initSimpleDTColumn:r,initAjaxTableOptions:p,initAjaxServerTableOptions:q,properties:i,getColumns:m}}]),app.factory("formService",["$http","localStorageService",function(b,c){function f(a){return b.post("\\DataImport\\GernerateJsonSchema",{baseinfo:e,AskString:a,remark:systemname}).then(function(a){var b=a.data;return null!=b?b:null})}var d=c.get(systemname+"LoginInfo"),e="";return null!=d&&(e=d._id),{formFieldOptions:f}}]),app.service("DataMgtService",["$http","$rootScope","localStorageService",function(b,c,d){function h(a,c){var d={datasetname:a,search:c};return b.post(g+"commDataListGet",{baseinfo:f,AskString:angular.toJson(d),remark:systemname}).then(function(a){return a.data})}function i(a,c,d,e){var h={datasetname:a,search:c,skip:d,limit:e};return b.post(g+"commDataListGetLimit",{baseinfo:f,AskString:angular.toJson(h),remark:systemname}).then(function(a){return a.data})}function j(a,c){var d={datasetname:a,search:c};return b.post(g+"commDataListGetWithDetail",{baseinfo:f,AskString:angular.toJson(d),remark:systemname}).then(function(a){return a.data})}function k(a,c,d,e){var h={datasetname:a,search:c,skip:d,limit:e};return b.post(g+"commDataListGetLimitWithDetail",{baseinfo:f,AskString:angular.toJson(h),remark:systemname}).then(function(a){return a.data})}function l(a,c){var d={datasetname:a,search:c};return b.post(g+"commDataPageListGet",{baseinfo:f,AskString:angular.toJson(d),remark:systemname}).then(function(a){return a.data})}function m(a,d,e){var h={datasetname:a,keyname:d,keyvalue:e};return b.post(g+"commDataDetailGet",{baseinfo:f,AskString:angular.toJson(h),remark:systemname}).then(function(a){if(!(a.data.toString().indexOf("错误")>=0||a.data.toString().indexOf("error")>=0))return a.data;c.AlertDialog.AlertDialogMessage=a.data,c.AlertDialog.showButton=!0,c.AlertDialog.AlertDialogOpen()})}function n(a,d){var e={datasetname:a,insertdata:d};return b.post(g+"commDataInsert",{baseinfo:f,AskString:angular.toJson(e),remark:systemname}).then(function(a){if(!(a.data.toString().indexOf("错误")>=0||a.data.toString().indexOf("error")>=0))return c.ResultMessageInfo="数据添加成功！！",a.data;c.AlertDialog.AlertDialogMessage=a.data,c.AlertDialog.showButton=!0,c.AlertDialog.AlertDialogOpen()})}function o(a,d,e,h,i){var j={datasetname:a,updatedata:d,updatefields:e,keyname:h,keyvalue:i};return b.post(g+"commDataUpdate",{baseinfo:f,AskString:angular.toJson(j),remark:systemname}).then(function(a){if(!(a.data.toString().indexOf("错误")>=0||a.data.toString().indexOf("error")>=0))return c.ResultMessageInfo="数据更新成功！！",a.data;c.AlertDialog.AlertDialogMessage=a.data,c.AlertDialog.showButton=!0,c.AlertDialog.AlertDialogOpen()})}function p(a,d,e){var h={datasetname:a,keyname:d,deletekeyvalue:e};return b.post(g+"commDataDelete",{baseinfo:f,AskString:angular.toJson(h),remark:systemname}).then(function(a){if(!(a.data.toString().indexOf("错误")>=0||a.data.toString().indexOf("error")>=0))return c.ResultMessageInfo="数据删除成功！！",a.data;c.AlertDialog.AlertDialogMessage=a.data,c.AlertDialog.showButton=!0,c.AlertDialog.AlertDialogOpen()})}function q(a,d,e){var h={datasetname:a,keyname:d,keyvalue:e};return b.post(g+"commDataClone",{baseinfo:f,AskString:angular.toJson(h),remark:systemname}).then(function(a){if(!(a.data.toString().indexOf("错误")>=0||a.data.toString().indexOf("error")>=0))return c.ResultMessageInfo="数据克隆/复制成功！！",a.data;c.AlertDialog.AlertDialogMessage=a.data,c.AlertDialog.showButton=!0,c.AlertDialog.AlertDialogOpen()})}function r(a,c,d){var e={datasetname:a,belongkeyname:c,belongkeyvalue:d};return b.post(g+"commonDataListGetFromArray",{baseinfo:f,AskString:angular.toJson(e),remark:systemname}).then(function(a){return a.data})}function s(a,d,e,h,i){var j={datasetname:a,belongkeyname:d,belongkeyvalue:e,keyname:h,keyvalue:i};return b.post(g+"commDataDetailGetFromArray",{baseinfo:f,AskString:angular.toJson(j),remark:systemname}).then(function(a){if(!(a.data.toString().indexOf("错误")>=0||a.data.toString().indexOf("error")>=0))return a.data;c.AlertDialog.AlertDialogMessage=a.data,c.AlertDialog.showButton=!0,c.AlertDialog.AlertDialogOpen()})}function t(a,d,e,h){var i={datasetname:a,belongkeyname:d,belongkeyvalue:e,insertdata:h};return b.post(g+"commDataInsertFromArray",{baseinfo:f,AskString:angular.toJson(i),remark:systemname}).then(function(a){if(!(a.data.toString().indexOf("错误")>=0||a.data.toString().indexOf("error")>=0))return c.ResultMessageInfo="数据添加成功！！",a.data;c.AlertDialog.AlertDialogMessage=a.data,c.AlertDialog.showButton=!0,c.AlertDialog.AlertDialogOpen()})}function u(a,d,e,h,i,j,k){var l={datasetname:a,belongkeyname:d,belongkeyvalue:e,updatedata:h,updatefields:i,keyname:j,keyvalue:k};return b.post(g+"commDataUpdateFromArray",{baseinfo:f,AskString:angular.toJson(l),remark:systemname}).then(function(a){if(!(a.data.toString().indexOf("错误")>=0||a.data.toString().indexOf("error")>=0))return c.ResultMessageInfo="数据更新成功！！",a.data;c.AlertDialog.AlertDialogMessage=a.data,c.AlertDialog.showButton=!0,c.AlertDialog.AlertDialogOpen()})}function v(a,d,e,h,i){var j={datasetname:a,belongkeyname:d,belongkeyvalue:e,keyname:h,deletekeyvalue:i};return b.post(g+"commDataDeleteFromArray",{baseinfo:f,AskString:angular.toJson(j),remark:systemname}).then(function(a){if(!(a.data.toString().indexOf("错误")>=0||a.data.toString().indexOf("error")>=0))return c.ResultMessageInfo="数据删除成功！！",a.data;c.AlertDialog.AlertDialogMessage=a.data,c.AlertDialog.showButton=!0,c.AlertDialog.AlertDialogOpen()})}function w(a,d,e,h,i){var j={datasetname:a,belongkeyname:d,belongkeyvalue:e,keyname:h,keyvalue:i};return b.post(g+"commDataCloneFromArray",{baseinfo:f,AskString:angular.toJson(j),remark:systemname}).then(function(a){if(!(a.data.toString().indexOf("错误")>=0||a.data.toString().indexOf("error")>=0))return c.ResultMessageInfo="数据克隆/复制成功！！",a.data;c.AlertDialog.AlertDialogMessage=a.data,c.AlertDialog.showButton=!0,c.AlertDialog.AlertDialogOpen()})}function x(a,c,d,e){var h={datasetname:a,valuefield:c,namefield:d,search:e};return b.post(g+"commGetDic",{baseinfo:f,AskString:angular.toJson(h),remark:systemname}).then(function(a){return a.data})}function y(a,c,d,e,h,i,j){var k={datasetname:a,valuefield:c,namefield:d,search:e,joindatasetname:h,joinsearch:i,joinfield:j};return b.post(g+"commGetDicWithOutData",{baseinfo:f,AskString:angular.toJson(k),remark:systemname}).then(function(a){return a.data})}function z(a,c,d,e,h,i){var j={datasetname:a,belongkeyname:c,belongkeyvalue:d,valuefield:e,namefield:h,search:i};return b.post(g+"commGetDicFromArray",{baseinfo:f,AskString:angular.toJson(j),remark:systemname}).then(function(a){return a.data})}function A(a,d){var e={datasetname:a,search:d};b.post(g+"RegDownload",{baseinfo:f,AskString:angular.toJson(e),remark:systemname}).then(function(a){if(a.data.toString().indexOf("错误")>=0||a.data.toString().indexOf("error")>=0)c.AlertDialog.AlertDialogMessage=a.data,c.AlertDialog.showButton=!0,c.AlertDialog.AlertDialogOpen();else{var b=g+"commDataExportExcel?baseinfo="+f+"&remark="+systemname+"&AskString="+a.data._id.$oid;window.open(b)}})}function B(a,d){var e={datasetname:a,search:d};b.post(g+"RegDownload",{baseinfo:f,AskString:angular.toJson(e),remark:systemname}).then(function(a){if(a.data.toString().indexOf("错误")>=0||a.data.toString().indexOf("error")>=0)c.AlertDialog.AlertDialogMessage=a.data,c.AlertDialog.showButton=!0,c.AlertDialog.AlertDialogOpen();else{var b=g+"commDataExportExcelFromArray?baseinfo="+f+"&remark="+systemname+"&AskString="+a.data;window.open(b)}})}function C(a,c,d,e){var h={fromdataset:a,joindataset:c,joinfield:d,isContain:e};b.post(g+"commDataListGetByJoin",{baseinfo:f,AskString:angular.toJson(h),remark:systemname}).then(function(a){return a.data})}function D(a,c){var d={datasetname:a,search:c};return b.post(g+"commDataStatic",{baseinfo:f,AskString:angular.toJson(d),remark:systemname}).then(function(a){return a.data})}function E(a,c,d,e){var h={datasetname:a,search:c,key:d,SumName:e};return b.post(g+"commDataStaticGroupSum",{baseinfo:f,AskString:angular.toJson(h),remark:systemname}).then(function(a){return a.data})}function F(a,c,d,e){var h={datasetname:a,search:c,key:d,CountName:e};return b.post(g+"commDataStaticGroupCount",{baseinfo:f,AskString:angular.toJson(h),remark:systemname}).then(function(a){return a.data})}var e=d.get(systemname+"LoginInfo"),f="",g="/ReturnData/";return null!=e&&(f=e._id),{commDataListGet:h,commDataListGetLimit:i,commDataListGetWithDetail:j,commDataListGetLimitWithDetail:k,commDataPageListGet:l,commDataDetailGet:m,commDataInsert:n,commDataUpdate:o,commDataDelete:p,commDataClone:q,commonDataListGetFromArray:r,commDataDetailGetFromArray:s,commDataInsertFromArray:t,commDataUpdateFromArray:u,commDataDeleteFromArray:v,commDataCloneFromArray:w,commGetDic:x,commGetDicWithOutData:y,commGetDicFromArray:z,commDataExportExcel:A,commDataExportExcelFromArray:B,commDataListGetByJoin:C,commDataStatic:D,commDataStaticGroupSum:E,commDataStaticGroupCount:F}}]),app.directive("htmlpopover",["$compile","$templateCache","$q","$http",function(a,b,c,d){var e=function(a){var e=c.defer(),f="";return f=b.get(a),void 0===f?d.get(a).success(function(c){b.put(a,c),e.resolve(c)}):e.resolve(f),e.promise};return{restrict:"A",link:function(b,c,d){var f=c.attr("templateurl");null!=f&&e(f).then(function(d){var e={container:"body",content:a(d)(b),html:!0,delay:1,date:b.date,trigger:"click"};$(c).popover(e).blur(function(){$(this).popover("hide")})})}}}]),app.directive("ngCsvImport",["$compile",function(a){return{transclude:!0,scope:{content:"=",filename:"=",header:"@",includeheader:"@includeheader",separator:"@separator",errMessage:"=errmessage",todo:"&"},controller:["$scope",function(b){this.compile=function(c){a(c)(b)}}],link:function(a,b,c){b.on("change",function(b){var c=b.target.files[0],e=/excel.*/;if(c.type.match(e)){var f=new FileReader;f.onload=function(b){var c={csv:f.result,header:a.includeheader,separator:a.separator};a.content=$.parseJSON(d(c,a.header)),a.$apply(),a.todo()},a.filename=c.fileName,f.readAsText(c,"gb2312")}else a.errMessage="不支持当前文件格式!"});var d=function(a,b){var c=a.csv.split("\r\n"),d=[],e=0,f=c[0].split(a.separator).length,g=[],h=!1;null!=b&&(g=b,h=!0),a.header&&(h||(g=c[0].split(a.separator)),e=1);for(var i=e;i<c.length;i++){var j={},k=c[i].split(a.separator);if(k.length===f){if(a.header)for(var l=0;l<g.length;l++)j[g[l]]=k[l];else for(var m=0;m<k.length;m++)j[m]=k[m];d.push(j)}}return JSON.stringify(d)}}}}]),app.directive("dateTimePicker",function(){return{restrict:"E",require:["ngModel"],scope:{ngModel:"=",name:"@",placeholder:"@",ngClass:"=",ngRequired:"@"},replace:!0,template:'<div><input type="text" name="{{name}}" ng-required="{{ngRequired}}"  class="form-control {{ngClass}}" placeholder="{{placeholder}}" value="{{ngModel}}"></div>',link:function(a,b,c){var d=b.find("input");d.datetimepicker({format:"yyyy/mm/dd hh:ii",showMeridian:!1,autoclose:!0,todayBtn:!0,todayHighlight:!0,language:"zh-CN",pickerPosition:"bottom-right"}),b.bind("blur keyup change click",function(b){a.ngModel=d.val(),a.$apply()})}}}),app.directive("datePicker",function(){return{restrict:"E",require:["ngModel"],scope:{ngModel:"=",name:"@",placeholder:"@",ngClass:"=",ngRequired:"@"},replace:!0,template:'<div><input type="text" name="{{name}}" ng-required="{{ngRequired}}"  class="form-control {{ngClass}}" placeholder="{{placeholder}}" value="{{ngModel}}"></div>',link:function(a,b,c){var d=b.find("input");d.datetimepicker({format:"yyyy/mm/dd",showMeridian:!1,minView:"month",autoclose:!0,todayBtn:!0,todayHighlight:!0,language:"zh-CN",pickerPosition:"bottom-right"}),b.bind("blur keyup change click",function(b){a.ngModel=d.val(),a.$apply()})}}}),app.directive("advancesearch",["$compile",function(a){return{restrict:"E",replace:!0,scope:{asShow:"=",asModel:"=",fields:"=",submit:"&",reset:"&"},controller:["$scope",function(a){a.plus=function(){var b={forerelation:"AND",field:"",condition:"=",keywords:""};a.asModel.data.length<=14&&a.asModel.data.push(b)},a.subtract=function(){a.asModel.data.length>1&&a.asModel.data.splice(a.asModel.data.length-1,1)},void 0==a.reset||null==a.reset?a.AdSearchReset=function(){a.asModel.data=[{field:"",keywords:"",condition:"="}]}:a.AdSearchReset=function(){a.asModel.data=[{field:"",keywords:"",condition:"="}],a.reset()},void 0!=a.submit&&null!=a.submit&&(a.AdSearchSubmit=function(){a.submit()})}],template:'<div class="col-md-12 AdSearch"><div ng-repeat="m in asModel.data track by $index" class="input-group col-md-12">        <div ng-show="$index==0" class="col-md-2">            <button style="width: 26px; height: 26px;" ng-click="plus()">+</button>            <button style="width: 26px; height: 26px;" ng-click="subtract()">-</button>        </div>        <div  ng-if="$index!=0" class="col-md-2">        <select ng-model="m.forerelation" title=""  class="form-control" >            <option value="AND" >并且</option>            <option value="OR" >或者</option>            <option value="AND NOT" >不含</option>        </select>        </div>        <div class="col-md-2">            <select ng-model="m.field" title=""  class="form-control" ng-options="x.value as x.name for x in fields"></select>        </div>    <div class="col-md-2">        <select ng-model="m.condition" title=""  class="form-control" >            <option value="=" >等于</option>            <option value="<>" >大于小于</option>            <option value="like" >包含</option>            <option value="left like" >左包含</option>            <option value="right like" >右包含</option>            <option value=">=" >大于等于</option>            <option value="<=" >小于等于</option>        </select>        </div>        <div class="col-md-3">            <input  type="text" ng-model="m.keywords"   placeholder="请输入关键字..." class="form-control">            </div>            <div class="btn-group col-md-2" ng-show="$index==0" >                <button  class="btn btn-md btn-success" ng-click="AdSearchSubmit()">检索</button>                <button  class="btn btn-md btn-danger" ng-click="AdSearchReset()">重置</button>            </div>        </div>    </div>'}}]),app.directive("commimport",["$compile",function(a){return{restrict:"E",replace:!0,scope:{asDataset:"=",belongkeyname:"=",belongkeyvalue:"=",exit:"&"},controller:["$scope","$http","$q","DTOptionsBuilder","DTColumnDefBuilder","localStorageService","tableService","$element","$attrs",function(a,b,c,d,e,f,g,h,i){a.pageshow={ShortCutImport:!0,datesetedit:!1,DrivingSchTransList:!1,ErrorMsg:!1},a.showErrorMsg=function(){a.pageshow=setObjectPropsToValue(a.pageshow,["ErrorMsg"],!a.pageshow.ErrorMsg,!1)};var j="\\DataImport\\ActionRoute",k=f.get(systemname+"LoginInfo");a.authUserid=k.authUserid,a._id=k._id,a.DataImportSets=[],a.NowImportSet={},a.importErrorMsg=[],a.ShortCutInputData="",a.checkboxes={checkedAll:!1,items:[],values:[],checkedNum:0};var l=a.asDataset?a.asDataset:"",m=a.belongkeyname?a.belongkeyname:"",n=a.belongkeyvalue?a.belongkeyvalue:"";a.DataImportOption={SelectedImportSet:l,belongkeyname:m,belongkeyvalue:n},a.importDTColumnDefs=[],a.importDTOptions=g.initSimpleTablesOption("tip"),a.ImportSetInit=function(){""!=a.DataImportOption.SelectedImportSet?b.post("\\DataImport\\GetDataImportSetDetail",{baseinfo:a._id,AskString:a.DataImportOption.SelectedImportSet,remark:systemname}).success(function(b){a.NowImportSet=b,a.importErrorMsg=[],a.ShortCutInputData="",a.checkboxes={checkedAll:!1,items:[],values:[],checkedNum:0}}).error(function(a,b){}):a.initErrorMsg="数据导入目标不明确，数据导入初始化错误！"},a.ImportSetInit(),a.getDataScheme=function(){var b="/ReturnData/commDataExportDataSchemeExcel?baseinfo="+a._id+"&AskString="+a.asDataset+"&remark="+systemname;window.open(b)},a.DataParse=function(){if(""!=a.ShortCutInputData){var b=CSVParser.parse(a.ShortCutInputData,"checked","auto",!1,!1);a.dataGrid=b.dataGrid,a.headerNames=b.headerNames,a.headerTypes=b.headerTypes;var d=(b.errors,null),e=DataGridRenderer.json(a.dataGrid,a.headerNames,a.headerTypes,"","");if(a.jsondataGrid=$.parseJSON(e),a.jsondataGrid.length=0)return void(a.ImportError="没有有效的导入数据！");g.initSimpleDTColumnDefs(a.DataImportOption.SelectedImportSet,1,a.NowImportSet).then(function(b){a.importDTColumnDefs=b;var c=g.getColumns();if(d=!0,angular.forEach(c,function(b,c){a.headerNames.indexOf(b.ColDBName)>=0||!d||(a.ImportError="导入的数据与所选数据模板不匹配！"+b.ColDBName+"不存在",d=!1)}),d){a.pageshow=setObjectPropsToValue(a.pageshow,["DrivingSchTransList"],!0,!0),a.importErrorMsg=[],a.checkboxes={checkedAll:!1,items:[],values:[],checkedNum:0};for(var e=0;e<a.dataGrid.length;e++)a.checkboxes.items[e]=!1}})}},a.toggleAll=function(){a.checkboxes.checkedNum=0,angular.forEach(a.checkboxes.items,function(b,c){a.checkboxes.items[c]=a.checkboxes.checkedAll}),a.checkboxes.checkedAll&&(a.checkboxes.checkedNum=a.checkboxes.items.length)},a.toggleOne=function(b){a.checkboxes.items[b]?a.checkboxes.checkedNum=a.checkboxes.checkedNum+1:a.checkboxes.checkedNum=a.checkboxes.checkedNum-1,a.checkboxes.checkedNum==a.checkboxes.items.length?a.checkboxes.checkedAll=!0:a.checkboxes.checkedAll=!1},a.successIDList=[];var o=0,p=0;a.importMessage="",a.afterImportData=[];var q=0;a.importData=function(c,d){if(d.length<=0){a.dataGrid=a.afterImportData.slice(0),a.checkboxes={checkedAll:!1,items:[],values:[],checkedNum:0};for(var e=0;e<a.dataGrid.length;e++)a.checkboxes.items[e]=!1}else{var f=d[0];c.importdata=JSON.stringify(f);var g=angular.toJson(c);b.post(serverURL+j,{action:"DataImportSet",baseinfo:"",AskString:g,remark:systemname}).success(function(b){if(angular.toJson(b).indexOf("错误")<0)o+=1,a.afterImportData.splice(a.afterImportData.indexOf(q),1);else{p+=1;var f=new Object;f.msg=b,a.importErrorMsg.push(f)}a.importMessage="成功"+o+"；错误："+p,d.splice(0,1),q+=1,a.importData(c,d)}).error(function(){var b=new Object;b.msg="网络传输错误！",a.importErrorMsg.push(b),p+=1,a.importMessage="成功"+o+"；错误："+p,d.splice(0,1),q+=1,a.importData(c,d)})}},a.ImportAllDataToServer=function(){o=0,p=0;a.importErrorMsg=[],a.importMessage="";var c=DataGridRenderer.json(a.dataGrid,a.headerNames,a.headerTypes,"","");a.jsondataGrid=$.parseJSON(c);var d={};d.TableCHName=a.NowImportSet.TableCHName,d.TargetCollection=a.NowImportSet.TargetCollection,d.TableDBName=a.NowImportSet.TableDBName,d.TargetDatabase=a.NowImportSet.TargetDatabase,d.ConDetecteField=a.NowImportSet.ConDetecteField,d.belongkeyname=a.DataImportOption.belongkeyname,d.belongkeyvalue=a.DataImportOption.belongkeyvalue,a.afterImportData=a.dataGrid.slice(0),a.importData(d,a.jsondataGrid)},a.ImportSelectedDataToServer=function(){var b=[];o=0,p=0;a.importErrorMsg=[],a.importMessage="",a.checkboxes.checkedAll?b=a.dataGrid:angular.forEach(a.checkboxes.items,function(c,d){c&&b.push(a.dataGrid[d])});var d=DataGridRenderer.json(b,a.headerNames,a.headerTypes,"","");a.jsondataGrid=$.parseJSON(d);var e={};e.TableCHName=a.NowImportSet.TableCHName,e.TargetCollection=a.NowImportSet.TargetCollection,e.TableDBName=a.NowImportSet.TableDBName,e.TargetDatabase=a.NowImportSet.TargetDatabase,e.ConDetecteField=a.NowImportSet.ConDetecteField,e.belongkeyname=a.DataImportOption.belongkeyname,e.belongkeyvalue=a.DataImportOption.belongkeyvalue,a.afterImportData=a.dataGrid.slice(0),a.importData(e,a.jsondataGrid)},a.ReloadImportData=function(){o=0,p=0,a.importErrorMsg=[],a.importMessage="",setObjectPropsToValue(a.pageshow,["ShortCutImport"],!0,!0)}}],template:'<div><div class="col-md-12 col-xs-12">            <div class="panel panel-default">        <div class="panel-heading">            <div class="panel-title">                <strong>快捷导入【{{NowImportSet.TableCHName}}】</strong> <button class="btn btn-danger btn-xs" ng-click="importexit()">结束数据导入</button>            </div>        </div>        <div ng-show="pageshow.ShortCutImport"  class="panel-body">        <span class="col-md-12 " style="margin-bottom: 15px;">您可以 <button class="btn btn-warning btn-xs" ng-click="getDataScheme()">获取数据模板</button>, 将需要导入的数据从Excel文件直接复制到下面的文本框中，然后 <button class="btn btn-warning btn-xs" ng-click="DataParse()"> 进行分析导入</button></span>        <span style="color: red">{{ImportError}}</span>    <div class="col-md-12 ">        <textarea class="col-md-12" rows="15" id="dataInput" ng-model="ShortCutInputData"></textarea>    </div>    </div>    </div></div><div class="panel panel-default" ng-show="pageshow.DrivingSchTransList">        <div class="panel-heading">            <span class="col-md-2 ">加载数据结果</span>            <button class="btn btn-success btn-xs" ng-click="ImportSelectedDataToServer()">导入所选数据</button>            <button class="btn btn-success btn-xs" ng-click="ImportAllDataToServer()">导入所有数据</button>            <button class="btn btn-error btn-xs" ng-click="ReloadImportData()">重新载入数据</button>            <button ng-if="importMessage != \'\'" class="btn btn-danger btn-xs" ng-click="showErrorMsg()">{{importMessage}}</button>            <p ng-show="pageshow.ErrorMsg" ng-repeat="m in importErrorMsg">                <span style="color: red">{{m.msg}}</span>            </p>        </div>        <table  ng-if="pageshow.DrivingSchTransList" datatable="ng" id="importDTInstance" dt-options="importDTOptions" dt-column-defs="importDTColumnDefs" class="row-border hover">            <thead>                <tr>                    <th><input type="checkbox" ng-model="checkboxes.checkedAll" ng-click="toggleAll()"></th>                        <th ng-repeat="header in headerNames">{{header}}</th>                    </tr>                </thead>                <tbody>                    <tr ng-repeat="m in dataGrid">                        <td><input type="checkbox" ng-click="toggleOne($index)" ng-model="checkboxes.items[$index]"></td>                            <td ng-repeat="colum in headerNames">{{m[$index]}}</td>                        </tr>                    </tbody>                </table>            </div>',link:function(a){a.$watch("asDataset",function(){a.asDataset?(a.ImportSetInit(),a.DataImportOption.SelectedImportSet=a.asDataset,a.DataImportOption.belongkeyname=a.belongkeyname,a.DataImportOption.belongkeyvalue=a.belongkeyvalue):(a.DataImportOption.SelectedImportSet="",a.DataImportOption.belongkeyname="",a.DataImportOption.belongkeyvalue="",a.NowImportSet={},a.importErrorMsg=[],a.ShortCutInputData="")}),a.importexit=function(){a.importErrorMsg=[],a.importMessage="",a.ShortCutInputData="",a.ImportError="",setObjectPropsToValue(a.pageshow,["ShortCutImport"],!0,!0),a.dataGrid=[],a.exit()}}}}]),app.directive("commdatamgt",["$compile",function(a){return{restrict:"E",replace:!0,scope:{dataset:"=",options:"=",id:"@",form:"=",editinfo:"=",otherform:"=",othereditinfo:"="},controller:["$compile","$scope","$rootScope","$http","$q","localStorageService","DTColumnDefBuilder","DTOptionsBuilder","DTInstances","DTColumnBuilder","tableService","formService","DataMgtService","schemaForm",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){var o=b;o.DataName="",o.pageshow={CommDataMgtTable:!0,CommDataTable:!0,CommDataEdit:!1,AdSearch:!1,dataimport:!1,CannotDoThis:!0,TheOtherCommDataEdit:!1},o.initCommData_dtColumns=null,o.getCommDataOption=null,o.search=[],o.CommData_dtOptions=null,o.CommData_dtColumns=[],o.CommDataEditSchema=null,o.editinfo={},o.othereditinfo={},o.DataSetDetail={},o.CommDataTableName=o.DataName+"ListTable";var p=o.DataName+"List_dtInstance",q=o.DataName+"List_data",r="";o.nowOptions={},o.CommDataAdSearchInfo={data:[{field:"",keywords:"",condition:"="}]},c[p]=null,c[q]=null,o.loadCommDataTable=function(){var c="/ReturnData/commDataListGet";if(o.CommData_dtColumns=[],void 0!=o.options.nowTableColumns&&null!=o.options.nowTableColumns?o.CommData_dtColumns=o.options.nowTableColumns.slice(0):o.CommData_dtColumns=o.initCommData_dtColumns.slice(0),void 0!=o.options.nowTableActions&&null!=o.options.nowTableActions&&o.options.nowTableActions.length>0&&o.CommData_dtColumns.push(j.newColumn(null).withTitle("操作").notSortable().withOption("width","150px").renderWith(function(b,c,d,e){var f='<div class="btn-group" role="group" aria-label="...">';return angular.forEach(o.options.nowTableActions,function(a,b){f=f+'<button class="btn '+a.ButtonType+' btn-xs" title="'+a.actionTitle+' "  ng-click="'+a.actionFuncName+"('"+e.row+"'"+(void 0==a.params?"":",'"+a.params+"'")+')">'+a.actionName+"</button>"}),f+="</div>"})),void 0!=o.options.getTableByJoin&&null!=o.options.getTableByJoin)c="/ReturnData/commDataListGetByJoin",o.getCommDataOption=o.options.getTableByJoin;else{if(void 0!=o.options.initSearch&&null!=o.options.initSearch&&(o.search=o.options.initSearch.slice(0)),void 0!=o.options.nowSearch&&null!=o.options.nowSearch)if(o.search.length>0){var d=[];d.push({join:"AND",0:o.search,1:o.options.nowSearch})}else o.search=o.options.nowSearch.slice(0);o.getCommDataOption={datasetname:o.DataName,search:o.search}}void 0==o.options.tabletype||""==o.tabletype||o.options.tabletype.indexOf("Server")<0||c.indexOf("join")>0?o.CommData_dtOptions=k.initAjaxTableOptions(c,function(a){a.baseinfo=b._id,a.AskString=angular.toJson(o.getCommDataOption),a.remark=systemname},o.CommDataTableName,p,q).withOption("createdRow",function(c,d,e){a(angular.element(c).contents())(b),o.$apply()}):o.CommData_dtOptions=k.initAjaxServerTableOptions("/ReturnData/commDataPageListGet",function(a){a.baseinfo=b._id,a.AskString=angular.toJson(o.getCommDataOption),a.remark=systemname},o.CommDataTableName,p,q).withOption("createdRow",function(c,d,e){a(angular.element(c).contents())(b),o.$apply()})},o.loadCommDataForm=function(){void 0!=o.options.ExtendEditForm&&null!=o.options.ExtendEditForm?o.form=o.options.ExtendEditForm.slice(0):o.form=[],void 0!=o.options.nowFormActions&&null!=o.options.nowFormActions?angular.forEach(o.options.nowFormActions,function(a,b){"save"==a.actionType&&o.form.push({type:"actions",items:[{type:"button",style:a.ButtonType,title:a.actionName,onClick:"saveCommDataInfo()"},{type:"button",style:"btn-info",title:"取消",onClick:"CommDataEditGoback()"}],condition:"NowCommDataAdd == false"}),"insert"==a.actionType&&o.form.push({type:"actions",items:[{type:"button",style:a.ButtonType,title:a.actionName,onClick:"insertCommData()"},{type:"button",style:"btn-info",title:"取消",onClick:"CommDataEditGoback()"}],condition:"NowCommDataAdd == true"})}):o.form.push({type:"actions",items:[{type:"button",style:"btn-success",title:"保存",onClick:"saveCommDataInfo()"},{type:"button",style:"btn-info",title:"取消",onClick:"CommDataEditGoback()"}],condition:"NowCommDataAdd == false"},{type:"actions",items:[{type:"button",style:"btn-success",title:"添加",onClick:"insertCommData()"},{type:"button",style:"btn-info",title:"取消",onClick:"CommDataEditGoback()"}],condition:"NowCommDataAdd == true"}),null!=o.options.FormInit&&void 0!=o.options.FormInit&&o.options.FormInit()};var s=function(){o.nowOptions=clone(o.options),void 0!=o.dataset&&""!=o.dataset&&m.commDataDetailGet("DataSets","TableDBName",o.dataset).then(function(a){if(null!=a){if(void 0!=o.CommDataTableName){var b=document.getElementById(o.CommDataTableName);null!=b&&b.remove()}o.DataSetDetail=a,o.DataName=o.dataset,o.importdataset=o.DataName;var c=o.DataSetDetail.Columns;o.CommDataAdSearchField=[],angular.forEach(c,function(a,b){a.IfShowInTable&&"multiselect"!=a.format&&o.CommDataAdSearchField.push({value:a.ColDBName,name:a.ColCHName})}),r=o.DataSetDetail.ConDetecteField.split(",")[0],o.initCommData_dtColumns=null,o.CommDataTableName=o.DataName+"ListTable",p=o.DataName+"List_dtInstance",q=o.DataName+"List_data",k.initSimpleDTColumn(o.DataName,0).then(function(a){o.initCommData_dtColumns=a,o.loadCommDataTable()}),null!=o.options.commEditScheme&&void 0!=o.options.commEditScheme&&""!=o.options.commEditScheme?(o.CommDataEditSchema=o.options.commEditScheme,o.loadCommDataForm()):l.formFieldOptions(o.DataName).then(function(a){o.CommDataEditSchema=a,o.loadCommDataForm()})}}),void 0!=o.options.OtherDataName&&""!=o.options.OtherDataName&&l.formFieldOptions(o.options.OtherDataName).then(function(a){o.TheOtherEditSchema=a,o.$broadcast("schemaFormRedraw")})};o.reloadCommDataPage=function(a){void 0!=a&&null!=a&&o[datainit](),o.loadCommDataTable(),o.loadCommDataForm()},o.reloadCommDataTable=function(){if(o.options=clone(o.nowOptions),void 0!=o.options.initSearch&&null!=o.options.initSearch&&(o.search=o.options.initSearch.slice(0)),void 0!=o.options.nowSearch&&null!=o.options.nowSearch)if(o.search.length>0){var a=[];a.push({join:"AND",0:o.search,1:o.options.nowSearch})}else o.search=o.options.nowSearch.slice(0);void 0!=o.search&&null!=o.search&&(o.getCommDataOption={datasetname:o.DataName,search:o.search}),c[p].reloadData(),o.pageshow=setObjectPropsToValue(o.pageshow,["CommDataMgtTable","CommDataTable"],!0,!0)},o.options.refreshTable=function(){if(o.options=clone(o.nowOptions),void 0!=o.options.getTableByJoin&&null!=o.options.getTableByJoin)getTableUrl="/ReturnData/commDataListGetByJoin",o.getCommDataOption=o.options.getTableByJoin;else{if(void 0!=o.options.initSearch&&null!=o.options.initSearch&&(o.search=o.options.initSearch.slice(0)),void 0!=o.options.nowSearch&&null!=o.options.nowSearch)if(o.search.length>0){var a=[];a.push({join:"AND",0:o.search,1:o.options.nowSearch})}else o.search=o.options.nowSearch.slice(0);void 0!=o.search&&null!=o.search&&(o.getCommDataOption={datasetname:o.DataName,search:o.search}),o.getCommDataOption={datasetname:o.DataName,search:o.search}}c[p].reloadData()},o.options.synCommEditInfo=function(){return o.editinfo},o.options.synOtherEditInfo=function(){return o.othereditinfo},s();var t=function(){if(o.options=clone(o.nowOptions),void 0!=o.options&&null!=o.options&&void 0!=o.options.nowdataset&&null!=o.options.nowdataset&&(o.dataset=o.options.nowdataset,o.DataName=o.dataset,o.DataSetDetail={},o.initCommData_dtColumns=null,o.getCommDataOption=null,o.search=[],o.CommData_dtOptions=null,o.CommData_dtColumns=[],o.CommDataEditSchema=null,o.CommDataTableName=o.DataName+"ListTable",p=o.DataName+"List_dtInstance",q=o.DataName+"List_data",r="",c[p]=null,c[q]=null),void 0!=o.options&&null!=o.options&&void 0!=o.options.needrefresh&&null!=o.options.needrefresh)switch(o.options.needrefresh){case"table":o.loadCommDataTable();break;case"form":o.loadCommDataForm();break;case"go":s()}};o.AddCommData=function(){o.editinfo={},o.pageshow=setObjectPropsToValue(o.pageshow,["CommDataEdit"],!0,!0),o.NowCommDataAdd=!0,void 0!=o.options&&null!=o.options&&null!=o.options.InsertBefore&&void 0!=o.options.InsertBefore&&(o.editinfo=o.options.InsertBefore())},o.callFunction=function(a){angular.isFunction(o[a])?o.options=o[a]():angular.isFunction(o.$parent[a])&&(o.options=o.$parent[a]()),t()},o.SimpleCallFunction=function(a){angular.isFunction(o[a])?o[a]():angular.isFunction(o.$parent[a])&&o.$parent[a]()},o.TableCallFunction=function(a,b){o.CommDataKeyValue=c[q][a][r],m.commDataDetailGet(o.DataName,r,o.CommDataKeyValue).then(function(a){null!=a&&($.extend(o.editinfo,a),angular.isFunction(o[b])?o[b](a):angular.isFunction(o.$parent[b])&&o.$parent[b](a))})};var u=function(a){void 0!=o.options&&void 0!=o.options.synCommEditInfo&&null!=o.options.synCommEditInfo&&o.options.synCommEditInfo(a)};o.CommDataInfoModify=function(a){o.CommDataKeyValue=c[q][a][r],m.commDataDetailGet(o.DataName,r,o.CommDataKeyValue).then(function(a){if(null!=a){var b=!0;void 0!=o.options&&void 0!=o.options.commModifyBeforeCheck&&null!=o.options.commModifyBeforeCheck&&(b=o.options.commModifyBeforeCheck(a)),b&&(o.editinfo=a,u(a),void 0!=o.options&&null!=o.options&&null!=o.options.ModifyBefore&&void 0!=o.options.ModifyBefore&&o.options.ModifyBefore(),o.pageshow=setObjectPropsToValue(o.pageshow,["CommDataMgtTable","CommDataEdit"],!0,!0),o.NowCommDataAdd=!1)}})},o.TheOtherCommDataInfoModify=function(a,b){o.CommDataKeyValue=c[q][a][r],m.commDataDetailGet(o.DataName,r,o.CommDataKeyValue).then(function(a){if(null!=a){var d=!0;void 0!=o.options&&void 0!=o.options.otherModifyBeforeCheck&&null!=o.options.otherModifyBeforeCheck&&(d=o.options.otherModifyBeforeCheck(a)),d&&(o.othereditinfo={},$.extend(o.editinfo,a),$.extend(o.othereditinfo,a),angular.isFunction(o[b])?o.options=o[b]():angular.isFunction(o.$parent[b])&&(o.options=o.$parent[b]()),null!=o.options.InsertOtherBefore&&void 0!=o.options.InsertOtherBefore&&(o.othereditinfo=o.options.InsertOtherBefore(o.othereditinfo)),void 0!=o.options.OtherEditConfirmSearch&&null!=o.options.OtherEditConfirmSearch?m.commDataListGet(o.options.OtherDataName,o.options.OtherEditConfirmSearch).then(function(a){a.length>0?(c.AlertDialog.AlertDialogMessage=o.options.OtherConfirmErrorMessage,c.AlertDialog.showButton=!0,c.AlertDialog.AlertDialogOpen()):l.formFieldOptions(o.options.OtherDataName).then(function(a){o.TheOtherEditSchema=a,o.pageshow=setObjectPropsToValue(o.pageshow,["TheOtherCommDataEdit"],!0,!0),o.$broadcast("schemaFormRedraw")})}):l.formFieldOptions(o.options.OtherDataName).then(function(a){o.TheOtherEditSchema=a,o.pageshow=setObjectPropsToValue(o.pageshow,["TheOtherCommDataEdit"],!0,!0),o.$broadcast("schemaFormRedraw")}))}})},o.saveCommDataInfo=function(){void 0!=o.options&&null!=o.options&&null!=o.options.saveCommBefore&&void 0!=o.options.saveCommBefore&&(o.editinfo=o.options.saveCommBefore(o.editinfo)),m.commDataUpdate(o.DataName,o.editinfo,null,r,b.CommDataKeyValue).then(function(a){void 0!=o.options&&null!=o.options&&void 0!=o.options.saveCommAfter&&null!=o.options.saveCommAfter?(o.options.saveCommAfter(o.editinfo),o.reloadCommDataTable()):o.reloadCommDataTable()})},o.cloneCommDataInfo=function(a){var b=c[q][a];m.commDataClone(o.DataName,r,b[r]).then(function(a){a&&o.reloadCommDataTable()})},o.insertCommData=function(){m.commDataInsert(o.DataName,o.editinfo).then(function(a){void 0!=o.options&&void 0!=o.options.insertCommAfter&&null!=o.options.insertCommAfter?(o.options.insertCommAfter(o.editinfo),o.reloadCommDataTable()):o.reloadCommDataTable()})},o.CommDataDelete=function(a){var b=c[q][a];m.commDataDelete(o.DataName,r,b[r]).then(function(a){a&&o.reloadCommDataTable()})},o.CommDataInfoPrint=function(a){o.CommDataKeyValue=c[q][a][r],m.commDataDetailGet(o.DataName,r,o.CommDataKeyValue).then(function(a){if(null!=a){var b="/BigDataMgt/Print.html?dataset="+o.DataName+"&keyvalue="+angular.toJson(o.CommDataKeyValue);window.open(b)}})},o.insertOtherCommData=function(){m.commDataInsert(o.options.OtherDataName,o.othereditinfo).then(function(a){a&&(void 0!=o.options.InsertOtherAfter&&null!=o.options.InsertOtherAfter?(o.options.InsertOtherAfter(o.editinfo,o.othereditinfo),o.reloadCommDataTable()):o.reloadCommDataTable())})},o.CommDataEditGoback=function(){o.pageshow=setObjectPropsToValue(o.pageshow,["CommDataMgtTable","CommDataTable"],!0,!0),o.options=clone(o.nowOptions)},o.exportCommDataInfo=function(){m.commDataExportExcel(o.getCommDataOption.datasetname,o.getCommDataOption.search)},o.CommDataAdSearchInfo={data:[{field:"",keywords:"",condition:"="}]},o.CommDataAdSearchField=o.options.AdSearchFields,o.showAdSearch=function(){o.pageshow=setObjectPropsToValue(o.pageshow,["AdSearch"],!o.pageshow.AdSearch,!1)},o.CommDataAdSearchGo=function(){var a=[];void 0!=o.CommDataAdSearchInfo.data&&null!=o.CommDataAdSearchInfo.data&&(void 0!=o.options.initSearch&&null!=o.options.initSearch&&o.search.length>0?a.push({join:"AND",0:o.search,1:o.CommDataAdSearchInfo.data}):a=o.CommDataAdSearchInfo.data.slice(0)),void 0!=o.options.initSearch&&null!=o.options.initSearch?o.search=o.options.initSearch.slice(0):o.search=[],o.getCommDataOption={datasetname:o.DataName,search:a},o.reloadCommDataTable()},o.ResetCommDataAdSearch=function(){var a=[];void 0!=o.options.initSearch&&null!=o.options.initSearch&&o.search.length>0&&(a=o.options.initSearch.slice(0)),o.getConsumInfoOption={datasetname:"ConsumInfo",search:a},o.reloadCommDataTable()},o.importdataset=o.dataset,o.importCommDataInfo=function(){o.pageshow=setObjectPropsToValue(o.pageshow,["dataimport"],!0,!0)}}],template:'<div><div ng-show="pageshow.CommDataMgtTable" class="panel panel-default"><div class="panel-heading" ng-show="options.MainAction.length > 0"><div class="btn-group"><button ng-repeat="m in options.MainAction" class="btn btn-xs {{m.ButtonType}}" ng-click="callFunction(m.actionFuncName)">{{m.actionName}}</button></div></div><advancesearch ng-if="pageshow.AdSearch" as-model="CommDataAdSearchInfo"  fields="CommDataAdSearchField" submit="CommDataAdSearchGo()" reset="ResetCommDataAdSearch()"></advancesearch><div ng-show="pageshow.CommDataTable"><table ng-if="CommData_dtOptions!=null" datatable="" id="{{CommDataTableName}}" dt-options="CommData_dtOptions" dt-columns="CommData_dtColumns" class="row-border hover"></table></div></div><div ng-show="pageshow.CommDataEdit" class="col-md-12 col-xs-12"><form id="{{id}}_form" sf-schema="CommDataEditSchema" sf-form="form" sf-model="editinfo" sf-options="{ validationMessage: { 302: \'该字段不能为空!\' }}"></form></div><div ng-show="pageshow.TheOtherCommDataEdit" class="col-md-12 col-xs-12"><form id="{{id}}_Otherform" sf-schema="TheOtherEditSchema" sf-form="otherform" sf-model="othereditinfo" sf-options="{ validationMessage: { 302: \'该字段不能为空!\' }}"></form></div><div ng-show="pageshow.dataimport"><commimport as-dataset="importdataset" exit="reloadCommDataTable()"></commimport></div></div>',link:function(a){}}}]),app.directive("filechange",[function(){return{scope:{filechange:"&"},link:function(a,b,c){b.bind("change",function(b){a.filechange()})}}}]).directive("fileuploader",["$compile","fileReader",function(a,b){return{restrict:"E",replace:!0,transclude:!0,require:"ngModel",scope:{ngModel:"=",directiveid:"@",maxfiles:"@",fileAccept:"@"},controller:["$scope","$http","$q","localStorageService","$element","$attrs",function(a,c,d,e,f,g){function h(){function b(b){for(var c=0;c<b.length;c++){a.files.map(function(a){return a.name}).indexOf(b[c].name)<0&&a.files.push(b[c])}}function c(){return a.files}function d(b){a.options=b,h(a.files,a.options.url,a.options.baseinfo,a.options.AskString)}function e(b){a.files.indexOf(b);a.files.splice(a.files.indexOf(b),1)}function f(){a.files.splice(0,a.files.length)}function h(b,c,d,e){var f,g,h,i="",j="file";if(a.activeUploads+=1,f=new window.XMLHttpRequest,g=new window.FormData,f.open("POST",c),f.upload.onloadstart=function(){},f.upload.onprogress=function(a){a.lengthComputable},f.onreadystatechange=function(){4==f.readyState&&200==f.status&&a.options.onCompleted(f.responseText)},f.onerror=function(){},i)for(h in i)i.hasOwnProperty(h)&&g.append(h,i[h]);for(var k=0;k<b.length;k++)g.append(j,b[k]);return g.append("baseinfo",d),g.append("AskString",e),f.send(g),f}var a=this;return a.files=[],a.options={},a.activeUploads=0,{addFiles:b,getFiles:c,files:a.files,startUpload:d,removeFile:e,removeAll:f}}var i=a;void 0==i.maxfiles?i.maxfiles=3:i.maxfiles=new Number(i.maxfiles),void 0==i.fileAccept&&(i.fileAccept="*/*");var h=h();i.importfile=null,i.uploadFiles=[],i.file_element=null,i.upload_file_remove=function(a){h.removeFile(a)},i.setImageSrc=function(a,b){a.imagesrc=b},i.NowReaderFileName="",i.$watch("imageTempSrc",function(){angular.forEach(i.uploadFiles,function(a){a.name==i.NowReaderFileName&&(a.imagesrc=i.imageTempSrc)})}),i.uploadfileChange=function(){if(0!=i.file_element.files.length&&(i.file_element=document.getElementById(i.directiveid),null!=i.file_element)){var c=i.file_element.files,d=!1;if(angular.forEach(i.ServerFiles,function(a){a.filename==c[0].name&&(d=!0)}),d)return;i.NowReaderFileName=c[0].name,h.addFiles(c),i.uploadFiles=h.getFiles();for(var e=["jpg","png","bmp","jpeg","gif","psd","xls","xlsx","txt","swf","ppt","pptx","doc","docx"],f=0;f<i.uploadFiles.length;f++){var g=i.uploadFiles[f].name.substr(i.uploadFiles[f].name.lastIndexOf(".")+1).toLocaleLowerCase();e.indexOf(g)>=0?a.uploadFiles[f].NowType=g:a.uploadFiles[f].NowType="other"}i.isimage(i.NowReaderFileName.substr(i.NowReaderFileName.lastIndexOf(".")+1).toLocaleLowerCase())&&b.readAsDataUrl(c[0],a).then(function(a){i.imageTempSrc=a}),i.$apply()}},i.upload_file_clean=function(){h.removeAll()},i.upload_file_clean(),i.uploadFiles=[],i.ServerFiles=[],i.filebaseinfo={},i.loginid=null,i.initServerFiles=function(){var a=e.get(systemname+"LoginInfo");null!=a&&(i.loginid=a._id,void 0!=i.ngModel&&null!=i.ngModel&&""!=i.ngModel?c.post(serverURL+"\\ReturnAchievement\\ActionRoute",{action:"GetAchieveInfo",baseinfo:i.loginid,AskString:i.ngModel}).success(function(a){if("object"==typeof a)i.filebaseinfo=a,i.ServerFiles=i.filebaseinfo.filenames||[];else{i.ngModel=""}}).error(function(a){}):(i.uploadFiles=[],i.ServerFiles=[],i.filebaseinfo={}))},i.initServerFiles(),i.server_file_delete=function(a){var b={_id:i.ngModel,delfilename:a};c.post(serverURL+"\\ReturnAchievement\\ActionRoute",{action:"DelAchieveFile",baseinfo:i.loginid,AskString:angular.toJson(b)}).success(function(a){if(a.indexOf("错误")>=0);else i.initServerFiles()}).error(function(a){})},i.isimage=function(a){return["jpg","png","bmp","jpeg","gif","psd"].indexOf(a)>=0},i.getImageSrc=function(c){b.readAsDataUrl(c,a).then(function(a){return a})},i.uploadfileupload=function(){h.startUpload({url:"/ReturnAchievement/AchieveUpload",concurrency:2,baseinfo:i.loginid,AskString:angular.toJson(i.filebaseinfo),onProgress:function(b){a.$apply()},onCompleted:function(b){if(b.indexOf("错误")<0){var c=JSON.parse(b),d=c._id.$oid;void 0!=i.ngModel&&null!=i.ngModel&&""!=i.ngModel&&i.ngModel==d||(i.ngModel=d),i.initServerFiles()}else a.responsedata=b;a.$apply(),h.removeAll(),a.uploadFiles=[]}})},i.uploadfileselect=function(){i.file_element=document.getElementById(i.directiveid),i.file_element.click()}}],template:'<div style="margin-bottom: 5px;"><div ng-repeat="fm in ServerFiles track by $index"><div class="filesuploadiconbox"><img ng-if="isimage(fm.filetype)" ng-src="/Achievies/{{fm.filepath}}" height="64px" width="64px"/><img  ng-if="!isimage(fm.filetype)"  ng-src=rootpath+"/images/filetype-icon/{{fm.filetype}}.png" height="64px" width="64px"/><span style="display: block;">{{fm.filename}}</span><span style="color:#3c763d;">已上传 </span><i ng-click="server_file_delete(fm.filename)" title="删除" class="fa fa-close" style="color: red; font-size: 12px; cursor: pointer;"></i></div></div><div ng-repeat="fm in uploadFiles track by $index"><div class="filesuploadiconbox"><img ng-if="isimage(fm.NowType)" ng-src="{{fm.imagesrc}}" height="64px" width="64px"/><img ng-if="!isimage(fm.NowType)" ng-src=rootpath+"/images/filetype-icon/{{fm.NowType}}.png" height="64px" width="64px"/><span style="display: block;">{{fm.name}}</span><span>{{fm.size}}</span><i ng-click="upload_file_remove(fm)" title="删除" class="fa fa-close" style="color: red; font-size: 12px; cursor: pointer;"></i><span></span><span ng-show="fm.loaded != undefined && fm.loaded != fm.size">正在上传</span><span ng-show="fm.loaded == fm.size">上传完毕</span></div></div><div><input id="{{directiveid}}" filechange="uploadfileChange()" type="file" style="display:none" accept="{{fileAccept}}"/><div class="filesuploadiconbox" ng-show="uploadFiles.length + ServerFiles.length < maxfiles"><img title="请选择要上传文件" ng-click="uploadfileselect()" ng-src=rootpath+"/images/filetype-icon/add.png" height="64px" width="64px"/><span></span><span style="display: block;">添加文件</span></div><div class="filesuploadiconbox" ng-show="uploadFiles.length > 0" ng-click="uploadfileupload()"><img title="有文件未上传" ng-src=rootpath+"/images/filetype-icon/uploadhover.png" height="64px" width="64px"/><span style="display: block;">上传文件</span></div></div></div>',link:function(a){a.$watch("ngModel",function(){a.initServerFiles()})}}}]);
